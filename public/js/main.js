document.addEventListener("DOMContentLoaded",function(){let e=document.querySelectorAll(".slide"),t=document.querySelectorAll(".indicator"),n=document.getElementById("prevBtn"),l=document.getElementById("nextBtn"),o=document.getElementById("heroTitle"),i=document.getElementById("heroSubtitle"),a=0,r;async function s(){let t=await fetch("/api/slideData");slideData=await t.json(),e.forEach((e,t)=>{let n=e.getAttribute("data-bg");e.style.backgroundImage=`url(${n})`}),y()}function c(n){e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),e[n].classList.add("active"),t[n].classList.add("active"),function e(t){let n=slideData[t];o.style.opacity="0",i.style.opacity="0",o.style.transform="translateY(20px)",i.style.transform="translateY(20px)",setTimeout(()=>{o.textContent=n.title,i.textContent=n.subtitle,o.style.opacity="1",i.style.opacity="1",o.style.transform="translateY(0)",i.style.transform="translateY(0)"},300)}(n),a=n}function d(){let t=(a+1)%e.length;c(t)}function m(){let t=(a-1+e.length)%e.length;c(t)}function y(){r&&clearInterval(r),r=setInterval(d,5e3)}function g(){r&&(clearInterval(r),r=null)}l&&l.addEventListener("click",()=>{g(),d(),y()}),n&&n.addEventListener("click",()=>{g(),m(),y()}),t.forEach((e,t)=>{e.addEventListener("click",()=>{g(),c(t),y()})});let p=document.querySelector(".hero");p&&(p.addEventListener("mouseenter",()=>{r&&g()}),p.addEventListener("mouseleave",()=>{r||y()}));let u=0,E=0,v=!1;if(p){p.addEventListener("pointerdown",e=>{("touch"===e.pointerType||"pen"===e.pointerType)&&(v=!0,u=e.clientX,E=e.clientY,g())}),p.addEventListener("pointermove",e=>{v&&(e.clientX,e.clientY)});let f=e=>{if(!v)return;v=!1;let t=e.clientX-u,n=e.clientY-E;40>Math.abs(n)&&Math.abs(t)>50&&(t<0?d():m()),y()};p.addEventListener("pointerup",f),p.addEventListener("pointercancel",()=>{v=!1,y()})}s();let $=document.getElementById("menuToggle"),I=document.getElementById("navMenu");if($&&I){$.addEventListener("click",function(){I.classList.toggle("active"),$.textContent=I.classList.contains("active")?"✕":"☰"});let h=I.querySelectorAll("a");h.forEach(e=>{e.addEventListener("click",function(){I.classList.remove("active"),$.textContent="☰"})})}let B=document.getElementById("ctaLink");B&&B.addEventListener("click",function(e){e.preventDefault();let t=document.getElementById("portfolio");t&&t.scrollIntoView({behavior:"smooth"})});let L=[],x=1;k();let b=document.getElementById("loadMoreBtn");async function k(){try{let e=await fetch("/api/projects");L=await e.json(),_(x),S()}catch(t){console.error("Errore nel caricamento del portfolio:",t)}}function _(e){let t=document.getElementById("portfolioGrid");if(!t)return;let n=(e-1)*6,l=L.slice(n,n+6);l.forEach(e=>{let n=document.createElement("div");n.className="portfolio-item",n.style.opacity="0",n.style.transform="translateY(30px)",n.innerHTML=`
            <div class="portfolio-image">
                <img src="${e.images[0]}" alt="${e.title}" loading="lazy">
                <div class="portfolio-overlay">
                    <div class="portfolio-info">
                        <h3>${e.title}</h3>
                    </div>
                </div>
            </div>
        `,n.addEventListener("click",function(){(function e(t){let n=L.find(e=>e.id===t);if(!n)return;C=n,j=0,document.getElementById("projectTitle").textContent=n.title,document.getElementById("projectDescription").textContent=n.fullDescription||n.description,document.getElementById("projectLocation").textContent=n.location||"—",document.getElementById("projectYear").textContent=n.data||"—",document.getElementById("projectType").textContent=n.type||"—",document.getElementById("projectCollab").textContent=n.collaboration||"—",document.getElementById("projectStatus").textContent=n.status||"—",w();let l=document.getElementById("projectModal");l.classList.add("active"),document.body.style.overflow="hidden"})(e.id)}),t.appendChild(n),setTimeout(()=>{n.style.transition="opacity 0.6s ease, transform 0.6s ease",n.style.opacity="1",n.style.transform="translateY(0)"},50)})}b&&b.addEventListener("click",function(){_(++x),S()});let C=null,j=0;function w(){if(!C||!C.images)return;let e=document.getElementById("mainImage"),t=document.getElementById("currentImageIndex"),n=document.getElementById("totalImages"),l=document.getElementById("galleryPrev"),o=document.getElementById("galleryNext");e.style.opacity="0",setTimeout(()=>{e.src=C.images[j],e.alt=`${C.title} - Image ${j+1}`,e.style.opacity="1"},200),t.textContent=j+1,n.textContent=C.images.length,l.disabled=0===j,o.disabled=j===C.images.length-1}function M(){let e=document.getElementById("projectModal");e.classList.remove("active"),document.body.style.overflow="",C=null,j=0}function Y(e){C&&C.images&&("next"===e&&j<C.images.length-1?j++:"prev"===e&&j>0&&j--,w())}function S(){let e=document.getElementById("loadMoreContainer");document.getElementById("loadMoreBtn");let t=document.getElementById("projectsCount");if(!e)return;let n=L.length,l=6*x;l<n?(e.style.display="block",t.textContent=`${l} di ${n}`):e.style.display="none"}window.addEventListener("scroll",function(){let e=document.querySelector("header");e&&(window.scrollY>50?e.style.background="rgba(44, 44, 44, 0.95)":e.style.background="transparent")});let T=new IntersectionObserver(function(e){e.forEach(e=>{e.isIntersecting&&(e.target.style.opacity="1",e.target.style.transform="translateY(0)")})},{threshold:.1,rootMargin:"0px 0px -50px 0px"});document.querySelectorAll(".about, .projects").forEach(e=>{e.style.opacity="0",e.style.transform="translateY(30px)",e.style.transition="opacity 0.8s ease-out, transform 0.8s ease-out",T.observe(e)});let q=document.getElementById("modalClose");q&&q.addEventListener("click",M);let A=document.getElementById("modalExpand");A&&A.addEventListener("click",function e(){let t=document.getElementById("projectModal");document.fullscreenElement?document.exitFullscreen():t.requestFullscreen().catch(e=>{console.log("Error attempting to enable fullscreen:",e)})});let D=document.getElementById("galleryPrev"),N=document.getElementById("galleryNext");D&&D.addEventListener("click",()=>Y("prev")),N&&N.addEventListener("click",()=>Y("next")),document.addEventListener("keydown",e=>{"Escape"===e.key?M():"ArrowLeft"===e.key&&C?Y("prev"):"ArrowRight"===e.key&&C&&Y("next")});let F=document.getElementById("projectModal");function P(e,{minNonSpace:t=10,maxLength:n=2e3}={}){if("string"!=typeof e)return!1;let l=e.trim();if(0===l.length||l.length>n)return!1;let o=l.replace(/\s/g,"").length;return!(o<t||/<[^>]*>/.test(l)||/(.)\1{9,}/.test(l))}function O(){let e=navigator.userAgent.toLowerCase(),t=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|windows phone|phone|mobile|tablet|kindle|playbook|silk|nexus|xoom|pixel|galaxy|note|oneplus|motorola|samsung|lg|htc|sony|nokia|asus|huawei|xiaomi|redmi|poco|realme|oppo|vivo/i.test(e),n=window.devicePixelRatio>1;return t&&n}function X(e,t){let n=document.createElement("div");n.className=`custom-dialog ${t}`,n.innerHTML=`
        <div class="custom-dialog-content">
            <p>${e}</p>
            <button class="dialog-btn">OK</button>
        </div>
    `,document.body.appendChild(n),n.querySelector(".dialog-btn").addEventListener("click",()=>{n.remove()}),n.addEventListener("click",e=>{e.target===n&&n.remove()}),setTimeout(()=>{n.parentElement&&n.remove()},5e3)}F&&F.addEventListener("click",e=>{e.target===F&&M()}),document.getElementById("contactForm").addEventListener("submit",async e=>{e.preventDefault();let t=document.getElementById("emailTo").value,n=document.getElementById("fullName").value.trim(),l=document.getElementById("email").value.trim(),o=(document.getElementById("message").value||"").trim(),i=document.getElementById("emailCC")?.value.trim()||"",a=document.getElementById("privacy").checked;if(console.log(a),!a){X("Devi accettare la privacy policy per inviare il messaggio.","error");return}let r=!0,s="";if(!1===P(n,{minNonSpace:2,maxLength:30})&&(s="Nome non valido!",r=!1),!1===P(o)&&(s="Messaggio troppo corto!",r=!1),!r){X(s,"error");return}try{let c=await fetch("/api/sendEmail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:t,fromEmail:l,name:n,subject:"From:Portfolio-architettogiovannaplomitallo.it",message:o,cc:i})}),d=await c.json();d.success?(X("Email inviata con successo!","success"),document.getElementById("contactForm").reset()):X("Errore nell'invio: "+d.error,"error")}catch(m){console.error("Errore:",m),X("Errore nella comunicazione con il server","error")}})});